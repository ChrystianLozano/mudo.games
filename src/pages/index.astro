---
import "../styles/global.css";
import { XMLParser } from "fast-xml-parser";

const channelId = import.meta.env.YOUTUBE_CHANNEL_ID;
const channelName = import.meta.env.YOUTUBE_CHANNEL_NAME ?? "mudo.games";
const siteUrl = import.meta.env.SITE ?? "https://mudo.games";
const pageTitle = `Últimos videos de ${channelName}`;
const pageDescription =
  "Explora los últimos videos, shorts y destacados de mudo.games con miniaturas, timeline y reproducción directa.";

if (!channelId) {
  throw new Error("Falta YOUTUBE_CHANNEL_ID en el entorno (.env)");
}

const feedUrl = `https://www.youtube.com/feeds/videos.xml?channel_id=${channelId}`;

let videos = [];
let spotlight = [];
let shorts = [];
let timeline = [];
let latest = null;
let fetchError = "";

try {
  const res = await fetch(feedUrl);
  if (!res.ok) throw new Error(`Respuesta ${res.status}`);
  const xml = await res.text();

  const parser = new XMLParser({
    ignoreAttributes: false,
    attributeNamePrefix: "",
    removeNSPrefix: true,
  });

  const data = parser.parse(xml);
  const entries = data?.feed?.entry ?? [];
  const items = Array.isArray(entries) ? entries : [entries];

  videos = items.slice(0, 10).map((entry) => {
    const id = entry.videoId;
    const title = entry.title ?? "Video";
    const published = entry.published ?? "";
    const description = entry?.group?.description ?? entry?.summary ?? "";

    const link = Array.isArray(entry.link)
      ? entry.link.find((l) => l.rel === "alternate")?.href
      : entry.link?.href;

    const thumbFromFeed = entry?.group?.thumbnail?.url;
    const thumbnail =
      thumbFromFeed ?? (id ? `https://i.ytimg.com/vi/${id}/hqdefault.jpg` : "");

    const lowerTitle = title.toLowerCase();
    const isShort =
      (typeof link === "string" && link.includes("/shorts/")) ||
      lowerTitle.includes("#shorts") ||
      lowerTitle.includes("short");

    return { id, title, published, link, thumbnail, isShort, description };
  });
  latest = videos[0] ?? null;
  spotlight = videos.slice(0, 3);
  shorts = videos.filter((video) => video.isShort).slice(0, 4);
  timeline = videos.slice(0, 8);
} catch (err) {
  fetchError = err instanceof Error ? err.message : "No se pudo cargar el feed";
}
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={pageDescription} />
    <meta name="robots" content="index,follow" />
    <meta name="theme-color" content="#0d2c30" />
    <link rel="canonical" href={siteUrl} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={siteUrl} />
    <meta property="og:site_name" content={channelName} />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <title>{pageTitle}</title>
  </head>
  <body>
    <div class="bg">
      <div class="glow"></div>
      <div class="orb orb-a"></div>
      <div class="orb orb-b"></div>
      <div class="lines"></div>
      <div class="grain"></div>
    </div>

    <header class="hero">
      <p class="eyebrow">Nuevos lanzamientos</p>
      <h1>
        Últimos videos de <span class="title-brand">mudo.games</span>
      </h1>
      <p class="sub">
        Gameplays más recientes. Destacado, spotlight, timeline y una sección
        especial para Shorts.
      </p>
      <div class="hero-actions">
        <a
          class="cta"
          href={`https://www.youtube.com/channel/${channelId}`}
          target="_blank"
          rel="noreferrer"
        >
          Ver canal completo
        </a>
        <span class="hint"
          >Actualizado automáticamente desde el feed oficial</span
        >
      </div>
      <div class="stats">
        <div>
          <span class="stat-label">Videos cargados</span>
          <strong class="stat-value">{videos.length}</strong>
        </div>
        <div>
          <span class="stat-label">Última publicación</span>
          <strong class="stat-value">
            {
              latest?.published
                ? new Date(latest.published).toLocaleDateString("es-MX")
                : "—"
            }
          </strong>
        </div>
        <div>
          <span class="stat-label">Shorts detectados</span>
          <strong class="stat-value">{shorts.length}</strong>
        </div>
      </div>
    </header>

    <main class="content">
      {
        fetchError && (
          <div class="error">
            <strong>No se pudo cargar el feed.</strong>
            <span>{fetchError}</span>
          </div>
        )
      }

      {
        latest && (
          <section class="feature">
            <div class="feature-copy">
              <p class="eyebrow">Destacado</p>
              <h2>{latest.title}</h2>
              <p class="meta">
                Publicado:{" "}
                {new Date(latest.published).toLocaleDateString("es-MX")}
              </p>
              <div class="chips">
                <span>Nuevo</span>
                <span>Feed oficial</span>
                <span>Calidad HQ</span>
              </div>
              <button
                class="cta js-open-modal"
                type="button"
                data-id={latest.id}
                data-title={latest.title}
                data-description={latest.description}
              >
                Ver estreno
              </button>
            </div>
            <button
              class="feature-media js-open-modal"
              type="button"
              data-id={latest.id}
              data-title={latest.title}
              data-description={latest.description}
              aria-label={`Reproducir ${latest.title}`}
            >
              {latest.thumbnail ? (
                <img
                  src={latest.thumbnail}
                  alt={`Miniatura de ${latest.title}`}
                  loading="lazy"
                />
              ) : (
                <div class="thumb-fallback">Sin miniatura</div>
              )}
              <span class="play big">▶</span>
            </button>
          </section>
        )
      }

      <section class="spotlight">
        <div class="section-head">
          <h3 class="section-title">Spotlight</h3>
          <p>Los tres lanzamientos más frescos listos para reproducirse.</p>
        </div>
        <div class="grid">
          {
            spotlight.map((video) => (
              <article class="card" key={video.id}>
                <button
                  class="thumb js-open-modal"
                  type="button"
                  data-id={video.id}
                  data-title={video.title}
                  data-description={video.description}
                  aria-label={`Reproducir ${video.title}`}
                >
                  {video.thumbnail ? (
                    <img
                      src={video.thumbnail}
                      alt={`Miniatura de ${video.title}`}
                      loading="lazy"
                    />
                  ) : (
                    <div class="thumb-fallback">Sin miniatura</div>
                  )}
                  <span class="play">▶</span>
                </button>
                <div class="card-body">
                  <h2>{video.title}</h2>
                  <p class="meta">
                    Publicado:{" "}
                    {video.published
                      ? new Date(video.published).toLocaleDateString("es-MX")
                      : ""}
                  </p>
                  <button
                    class="link js-open-modal"
                    type="button"
                    data-id={video.id}
                    data-title={video.title}
                    data-description={video.description}
                  >
                    Ver video
                  </button>
                </div>
              </article>
            ))
          }
        </div>
      </section>

      <section class="shorts">
        <div class="section-head">
          <h3 class="section-title">Shorts</h3>
          <p>Clips rápidos detectados por el feed.</p>
        </div>
        <div class="shorts-row">
          {
            shorts.length > 0 ? (
              shorts.map((video) => (
                <button
                  class="short-card js-open-modal"
                  key={video.id}
                  type="button"
                  data-id={video.id}
                  data-title={video.title}
                  data-description={video.description}
                  aria-label={`Reproducir ${video.title}`}
                >
                  {video.thumbnail ? (
                    <img
                      src={video.thumbnail}
                      alt={`Miniatura de ${video.title}`}
                      loading="lazy"
                    />
                  ) : (
                    <div class="thumb-fallback">Sin miniatura</div>
                  )}
                  <div class="short-info">
                    <span>Short</span>
                    <h4>{video.title}</h4>
                  </div>
                </button>
              ))
            ) : (
              <div class="empty">
                No se detectaron Shorts en los últimos videos.
              </div>
            )
          }
        </div>
      </section>

      <section class="timeline">
        <div class="section-head">
          <h3 class="section-title">Timeline</h3>
          <p>Una línea rápida con las publicaciones más recientes.</p>
        </div>
        <div class="timeline-list">
          {
            timeline.map((video) => (
              <button
                class="timeline-item js-open-modal"
                key={video.id}
                type="button"
                data-id={video.id}
                data-title={video.title}
                data-description={video.description}
              >
                <span class="timeline-date">
                  {video.published
                    ? new Date(video.published).toLocaleDateString("es-MX")
                    : "—"}
                </span>
                <span class="timeline-title">{video.title}</span>
                <span class="timeline-arrow">↗</span>
              </button>
            ))
          }
        </div>
      </section>

      <section class="all-videos">
        <div class="section-head">
          <h3 class="section-title">Todos los últimos 10</h3>
          <p>La lista completa del feed, lista para maratonear.</p>
        </div>
        <div class="grid">
          {
            videos.map((video) => (
              <article class="card" key={video.id}>
                <button
                  class="thumb js-open-modal"
                  type="button"
                  data-id={video.id}
                  data-title={video.title}
                  data-description={video.description}
                  aria-label={`Reproducir ${video.title}`}
                >
                  {video.thumbnail ? (
                    <img
                      src={video.thumbnail}
                      alt={`Miniatura de ${video.title}`}
                      loading="lazy"
                    />
                  ) : (
                    <div class="thumb-fallback">Sin miniatura</div>
                  )}
                  <span class="play">▶</span>
                </button>
                <div class="card-body">
                  <h2>{video.title}</h2>
                  <p class="meta">
                    Publicado:{" "}
                    {video.published
                      ? new Date(video.published).toLocaleDateString("es-MX")
                      : ""}
                  </p>
                  <button
                    class="link js-open-modal"
                    type="button"
                    data-id={video.id}
                    data-title={video.title}
                    data-description={video.description}
                  >
                    Ver video
                  </button>
                </div>
              </article>
            ))
          }
        </div>
      </section>
    </main>

    <div class="modal" id="video-modal" aria-hidden="true">
      <div class="modal-backdrop" data-close="true"></div>
      <div
        class="modal-card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="modal-title"
      >
        <button
          class="modal-close"
          type="button"
          aria-label="Cerrar"
          data-close="true"
        >
          ✕
        </button>
        <div class="modal-media">
          <iframe
            id="modal-iframe"
            title="Reproductor de YouTube"
            src=""
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen></iframe>
        </div>
        <div class="modal-info">
          <p class="eyebrow">Reproduciendo</p>
          <h3 id="modal-title"></h3>
          <p id="modal-description" class="modal-desc"></p>
          <a
            id="modal-link"
            class="cta modal-cta"
            href="#"
            target="_blank"
            rel="noreferrer"
          >
            Ver en YouTube
          </a>
        </div>
      </div>
    </div>

    <footer class="footer">
      <span
        >Hecho con Astro + YouTube RSS - desarrollado por <a
          href="https://chrystian.dev">Chrystian Fabian Lozano Ramirez</a
        ></span
      >
    </footer>

    <script is:inline>
      const modal = document.querySelector("#video-modal");
      const iframe = document.querySelector("#modal-iframe");
      const title = document.querySelector("#modal-title");
      const description = document.querySelector("#modal-description");
      const link = document.querySelector("#modal-link");

      let viewedSet = new Set();

      try {
        const stored = JSON.parse(localStorage.getItem("viewedVideos") || "[]");
        if (Array.isArray(stored)) viewedSet = new Set(stored);
      } catch {
        viewedSet = new Set();
      }

      const syncViewed = (id) => {
        if (!id) return;
        document.querySelectorAll(`[data-id="${id}"]`).forEach((el) => {
          el.classList.add("is-viewed");
        });
      };

      viewedSet.forEach((id) => syncViewed(id));

      const openModal = (data) => {
        if (!data?.id) return;
        const url = `https://www.youtube.com/embed/${data.id}?autoplay=1&rel=0`;
        iframe.src = url;
        title.textContent = data.title || "Video";
        description.textContent =
          data.description || "Sin descripcion disponible.";
        link.href = `https://www.youtube.com/watch?v=${data.id}`;
        modal.setAttribute("aria-hidden", "false");
        modal.classList.add("is-open");
        document.body.style.overflow = "hidden";

        if (!viewedSet.has(data.id)) {
          viewedSet.add(data.id);
          try {
            localStorage.setItem(
              "viewedVideos",
              JSON.stringify([...viewedSet]),
            );
          } catch {}
        }
        syncViewed(data.id);
      };

      const closeModal = () => {
        modal.classList.add("is-closing");
        modal.classList.remove("is-open");
        document.body.style.overflow = "";
        const cleanup = () => {
          modal.setAttribute("aria-hidden", "true");
          modal.classList.remove("is-closing");
          iframe.src = "";
        };
        setTimeout(cleanup, 260);
      };

      document.querySelectorAll(".js-open-modal").forEach((el) => {
        el.addEventListener("click", () => {
          openModal({
            id: el.dataset.id,
            title: el.dataset.title,
            description: el.dataset.description,
          });
        });
      });

      modal.addEventListener("click", (event) => {
        if (event.target?.dataset?.close === "true") closeModal();
      });

      window.addEventListener("keydown", (event) => {
        if (event.key === "Escape") closeModal();
      });

      const root = document.documentElement;
      const mq = window.matchMedia("(pointer: fine)");

      const setParallax = (event) => {
        const x = (event.clientX / window.innerWidth) * 2 - 1;
        const y = (event.clientY / window.innerHeight) * 2 - 1;
        root.style.setProperty("--cursor-x", x.toFixed(3));
        root.style.setProperty("--cursor-y", y.toFixed(3));
      };

      if (mq.matches) {
        window.addEventListener("pointermove", setParallax, { passive: true });
      }
    </script>
  </body>
</html>
